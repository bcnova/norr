<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8' />
<link href='./lib/fullcalendar.min.css' rel='stylesheet' />
<link href='./lib/scheduler.min.css' rel='stylesheet' />
<link href='./lib/bootstrapmodal.css' rel='stylesheet' />
<script src='./lib/moment.min.js'></script>
<script src='./lib/jquery.min.js'></script>
<script src='./lib/fullcalendar.min.js'></script>
<script src='./lib/scheduler.min.js'></script>
<script src='./lib/bootstrapmodal.min.js'></script>
<script>

	$(function() { // document ready

		$('#calendar').fullCalendar({
			defaultView: 'agendaDay',
			validRange: function(nowDate) {
			//console.log(nowDate.format() + " " + nowDate.valueOf());
				//console.log(nowDate.valueOf() + " " + nowDate.dateString());
				return {
					start: nowDate.clone().subtract(1, 'week'),
					end: nowDate.clone().add(1, 'week')
				};
			},
			//defaultDate: '2017-05-07',
			editable: true,
			selectable: true,
			scrollTime: '08:00', // undo default 6am scrollTime
			eventLimit: true, // allow "more" link when too many events
			eventOverlap: false, // will cause the event to take up entire resource height
			header: {
				left: 'prev,next today',
				center: 'title',
				right: ''
				//right: 'agendaDay,agendaTwoDay,agendaWeek,month'
			},
			views: {
				agendaTwoDay: {
					type: 'agenda',
					duration: { days: 2 },

					// views that are more than a day will NOT do this behavior by default
					// so, we need to explicitly enable it
					groupByResource: true

					//// uncomment this line to group by day FIRST with resources underneath
					//groupByDateAndResource: true
				}
			},

			//// uncomment this line to hide the all-day slot
			allDaySlot: false,

			resources: [
				{ id: 'a', title: 'Meeting Room 1', eventColor: 'green' },
				{ id: 'b', title: 'Meeting Room 2', eventColor: 'orange' },
				{ id: 'c', title: 'Meeting Room 3', eventColor: 'red' },
			],
			
			events: { // you can also specify a plain string like 'json/events.json'
				url: 'https://api.myjson.com/bins/15zkpf',
				error: function() {
					$('#script-warning').show();
				}
			},			

			select: function(start, end, jsEvent, view, resource) {
				console.log(
					'select',
					start.format(),
					end.format(),
					resource ? resource.id : '(no resource)'
				);
				
				if (start.isBefore(moment().startOf('day')))
					return;
				
				$('#modalDelete').attr('onclick', "");
				$('#modalTitle').html("New Event");
				$("#modalStartTime").html(start.format('MMM Do h:mm A'));
				$("#modalEndTime").html(end.format('MMM Do h:mm A'));
				$('#modalEventResourceId').attr('value', resource.id);
				$('#fullCalModal').modal();
			},
			
			eventClick: function(calEvent, jsEvent, view) {
				//alert('Event: ' + calEvent.title + '\n' +
				//'Schedule: ' + calEvent.start.format() + ' - ' + calEvent.end.format());
				//alert('Schedule: ' + calEvent.start.format() + ' - ' + calEvent.end.format() );
				//alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
				//alert('View: ' + view.name);

				//console.log("event id: "+calEvent.id);
				//$('#modalDelete').attr('onclick', "onDeleteEvent("+calEvent.id+")");
				$('#modalEventId').attr('value', calEvent.id);
				$('#modalEventResourceId').attr('value', calEvent.resourceId);
				$('#modalDelete').attr('onclick', "onDeleteEvent()");
				$('#modalSave').attr('onclick', "onSaveEvent()");
				$('#modalTitle').html(calEvent.title);
				$("#modalStartTime").html(calEvent.start.format('MMM Do h:mm A'));
				$("#modalEndTime").html(calEvent.end.format('MMM Do h:mm A'));
				$('#fullCalModal').modal();
			
			},
			
			eventDrop: function(event, delta, revertFunc) {

				//alert(event.title + " was dropped on " + event.start.format());
				console.log(event);
				console.log(event.end.isAfter(moment()));
				console.log(event.end.isBefore(moment()));
				console.log(event.end.format());
				console.log(event.end);
				console.log(moment());
				console.log(moment().format("YYYY-MM-DDTHH:mm:ss"));
				if (event.end.isBefore(moment())) {
					revertFunc();
					//$('#fullCalModal').modal('hide');
					return;
				}
				if (!confirm("Are you sure about this change?")) {
					revertFunc();
					return;
				}
				
				var calendarJson = [];
				var calendarData = $('#calendar').fullCalendar('clientEvents');
				calendarData.forEach(function(calData) 
				{
					var eventJson = {};
					eventJson["id"] = calData.id;
					if (event.id == calData.id) {
						eventJson["resourceId"] = event.resourceId;
						eventJson["start"] = event.start.format();
						eventJson["end"] = event.end.format();
					} else {
						eventJson["resourceId"] = calData.resourceId;
						eventJson["start"] = calData.start._i;
						eventJson["end"] = calData.end._i;
					}
					eventJson["title"] = calData.title;
					calendarJson.push(eventJson);
				});
				console.log(calendarJson);
				updateSource(calendarJson);

			}, 
			eventResize: function(event, delta, revertFunc) {

				//alert(event.title + " was resized on " + event.start.format());
				if (event.end.isBefore(moment())) {
					//$('#fullCalModal').modal('hide');
					revertFunc();
					return;
				}
				if (!confirm("Are you sure about this change?")) {
					revertFunc();
					return;
				}
				var calendarJson = [];
				var calendarData = $('#calendar').fullCalendar('clientEvents');
				calendarData.forEach(function(calData) 
				{
					var eventJson = {};
					eventJson["id"] = calData.id;
					eventJson["resourceId"] = calData.resourceId;
					if (event.id == calData.id) {
						eventJson["start"] = event.start.format();
						eventJson["end"] = event.end.format();
					} else {
						eventJson["start"] = calData.start._i;
						eventJson["end"] = calData.end._i;
					}
					eventJson["title"] = calData.title;
					calendarJson.push(eventJson);
				});
				console.log(calendarJson);
				updateSource(calendarJson);	
				
				
				
			}
			
			
		});
		

	
	});
	
	function updateSource(calendarJson) {
		$.ajax({
			url:"https://api.myjson.com/bins/15zkpf",
			type:"PUT",
			data:JSON.stringify(calendarJson),
			contentType:"application/json; charset=utf-8",
			dataType:"json",
			success: function(data, textStatus, jqXHR){
				//$.get("https://api.myjson.com/bins/15zkpf", function(data, textStatus, jqXHR) {
				//	var json = JSON.stringify(data);
				//	$("#data").val(json);
				//});
				$('#fullCalModal').modal('hide');
				$('#calendar').fullCalendar('refetchEvents');
			}
		}); 
	};
	
	function onDeleteEvent() {
		var deleteID = $('#modalEventId').val();
		//if (moment($("#modalEndTime").html(), 'MMM Do h:mm A').isBefore(moment())) {
		//	$('#fullCalModal').modal('hide');
		//	return;
		//}
		console.log("deleting event " + document.getElementById('modalEventId').value);
		
		var calendarJson = [];
		var calendarData = $('#calendar').fullCalendar('clientEvents');
		calendarData.forEach(function(event) 
		{
			if (event.id != deleteID) {
				var eventJson = {};
				eventJson["id"] = event.id;
				eventJson["resourceId"] = event.resourceId;
				eventJson["start"] = event.start._i;
				eventJson["end"] = event.end._i;
				eventJson["title"] = event.title;
				calendarJson.push(eventJson);
			}
		});
	
		updateSource(calendarJson);
		
	
	};
	function onSaveEvent() {
		console.log("save event ");
		var calendarJson = [];
		
		var last7DayStart = moment().startOf('day').subtract(1,'week');
		var next7DayEnd = moment().startOf('day').add(1,'week');
		
		var eventJson = {};
		eventJson["id"] = "0";
		eventJson["resourceId"] = $('#modalEventResourceId').val();	
		eventJson["start"] = moment($("#modalStartTime").html(), 'MMM Do h:mm A').format("YYYY-MM-DDTHH:mm:ss");
		eventJson["end"] = moment($("#modalEndTime").html(), 'MMM Do h:mm A').format("YYYY-MM-DDTHH:mm:ss");
		eventJson["title"] = $('#modalTitle').html();

		console.log(eventJson["start"])
		var calendarData = $('#calendar').fullCalendar('clientEvents');
		var maxID = 1;
		calendarData.forEach(function(event) 
		{
			if (event.end.isBetween(last7DayStart, next7DayEnd)) {
				console.log("add");
				var eventJson = {};
				eventJson["id"] = event.id;
				eventJson["resourceId"] = event.resourceId;
				eventJson["start"] = event.start._i;
				eventJson["end"] = event.end._i;
				eventJson["title"] = event.title;
				calendarJson.push(eventJson);
				maxID = Math.max(maxID, event.id);
			}
		});
		eventJson["id"] = (maxID+1).toString();
		calendarJson.push(eventJson);

		updateSource(calendarJson);
	};
</script>
<style>

	body {
		margin: 0;
		padding: 0;
		font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
		font-size: 14px;
	}

	#calendar {
		max-width: 900px;
		margin: 50px auto;
	}

</style>
</head>
<body>

	<div id='calendar'></div>

<div id="fullCalModal" class="modal fade">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span> <span class="sr-only">close</span></button>
                <h4 id="modalTitle" class="modal-title"></h4>
            </div>
			<div id="modalBody" class="modal-body">
				<input type="hidden" id="modalEventId" value="">
				<input type="hidden" id="modalEventResourceId" value="">
				Name: <input type="text" id="modalEventOwner" required> <br>
				Start: <span id="modalStartTime"></span><br><br>
				End: <span id="modalEndTime"></span>
			</div>

            <div class="modal-footer">
                <!--<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>-->
				<button id="modalDelete" class="btn btn-default" onclick="">Delete</a></button>
                <button id="modalSave" class="btn btn-primary" onclick="onSaveEvent()">Save</button>
            </div>
        </div>
    </div>
</div>
	
	
</body>
</html>
